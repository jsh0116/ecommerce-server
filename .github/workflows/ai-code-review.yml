name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-review:
    name: AI Code Review with Multiple Tools
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # CodeRabbit AI Review (ê¶Œì¥: í•œêµ­ì–´ ì§€ì›, í•œêµ­ì¸ ê°œë°œì ìµœì í™”)
      - name: CodeRabbit Review
        uses: coderabbitai/coderabbit-action@v1
        with:
          framework: spring-boot
          language: kotlin
          # Optional: í† í°ì€ í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ê±°ë‚˜ GitHub Secrets ì‚¬ìš©
          skip_summary: false
          language_preference: korean  # í•œêµ­ì–´ ë¦¬ë·° ì„ í˜¸

      # Deepcode (Snyk) - ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„
      - name: Deepcode Analysis
        uses: snyk/actions/kotlin-gradle@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=build.gradle.kts --severity-threshold=high
        continue-on-error: true

      # Sonarqube ë¶„ì„ (ì„ íƒì‚¬í•­: ìì²´ í˜¸ìŠ¤íŒ…)
      - name: SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        if: ${{ secrets.SONAR_TOKEN != '' }}
        continue-on-error: true

      # Kotlin Linter & Formatter ê²€ì‚¬
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Check Kotlin code style
        run: |
          chmod +x gradlew
          ./gradlew lintKotlin
        continue-on-error: true

      # ìë™ ì½”ë©˜íŠ¸: ì½”ë“œ ë¦¬ë·° ìš”ì•½
      - name: Post AI Review Summary
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## ğŸ¤– AI Code Review Summary

            AI ì½”ë“œ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            ### ğŸ“Š ê²€ì‚¬ í•­ëª©:
            - âœ… CodeRabbit AI Review - Kotlin/Spring Boot ìµœì í™” ë¶„ì„
            - âœ… Deepcode Security - ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
            - âœ… Code Style - Kotlin ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ì¤€ìˆ˜ ì—¬ë¶€
            
            ### ğŸ’¡ ì£¼ì˜ì‚¬í•­:
            - CI/CD ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”
            - ë¦¬ë·° ì½”ë©˜íŠ¸ì— ì‘ë‹µí•´ì£¼ì„¸ìš”
            - ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•´ì•¼ ë¨¸ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤
            
            ### ğŸ”— ë§í¬:
            - [Test Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [PR Files Changed](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/files)
            
            *ìì„¸í•œ ë‚´ìš©ì€ ìœ„ì˜ ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.*`;

            // ê¸°ì¡´ ë¦¬ë·° ì½”ë©˜íŠ¸ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes('AI Code Review Summary')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // ìƒˆë¡œìš´ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
