name: Copilot AI Review (Optional)

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  copilot-review:
    name: GitHub Copilot Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # GitHub Copilotë¥¼ í†µí•œ ì½”ë“œ ë¦¬ë·°
      # ì°¸ê³ : GitHub Enterprise ë˜ëŠ” Copilot êµ¬ë… í•„ìš”
      - name: Copilot Code Review
        uses: github/copilot-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}
        with:
          review_mode: detailed
          language: kotlin
          framework: spring-boot
          focus_areas: |
            - Performance optimization
            - Security vulnerabilities
            - Best practices
            - Code clarity
        continue-on-error: true

      # ëŒ€ì•ˆ: OpenAI APIë¥¼ ì‚¬ìš©í•œ ì»¤ìŠ¤í…€ ë¦¬ë·°
      - name: Custom AI Review (OpenAI)
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        uses: actions/github-script@v8
        with:
          script: |
            const https = require('https');

            // PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const kotlinFiles = files.filter(f =>
              f.filename.endsWith('.kt')
            );

            if (kotlinFiles.length === 0) {
              console.log('No Kotlin files to review');
              return;
            }

            // ë³€ê²½ ë‚´ì—­ ìš”ì•½
            const changes = kotlinFiles.slice(0, 5).map(f =>
              `- ${f.filename}: ${f.additions} additions, ${f.deletions} deletions`
            ).join('\n');

            const reviewComment = `## ðŸ¤– Automated Code Review

            **Changed Files:**
            ${changes}
            
            ${kotlinFiles.length > 5 ? `... and ${kotlinFiles.length - 5} more files` : ''}
            
            ### Review Focus:
            - [ ] Code quality and readability
            - [ ] Performance considerations
            - [ ] Security best practices
            - [ ] Test coverage
            - [ ] Documentation
            
            *For detailed AI-powered analysis, please check the CI/CD results above.*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewComment
            });
