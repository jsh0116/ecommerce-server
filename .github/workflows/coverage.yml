name: Code Coverage Report

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Build and Generate Coverage
        run: |
          chmod +x gradlew
          ./gradlew test jacocoTestReport
        env:
          GRADLE_OPTS: "-Xmx2048m"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/reports/jacoco/test/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Comment PR with Coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // JaCoCo ë¦¬í¬íŠ¸ íŒŒì¼ ì½ê¸° ì‹œë„
            const reportPath = './build/reports/jacoco/test/jacocoTestReport.xml';

            let coverageComment = `## ğŸ“Š Code Coverage Report

            **Coverage Status:**
            - ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
            - Codecovì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤
            
            **ì£¼ì˜:**
            - ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ë•ŒëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë„ í•¨ê»˜ ì‘ì„±í•´ì£¼ì„¸ìš”
            - ê°€ëŠ¥í•œ í•œ ë†’ì€ ì»¤ë²„ë¦¬ì§€ë¥¼ ëª©í‘œë¡œ í•©ë‹ˆë‹¤
            
            **ë§í¬:**
            - [Codecov Dashboard](https://codecov.io/gh/${{ github.repository }})
            - [JaCoCo Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: coverageComment
            });

      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: jacoco-report
          path: build/reports/jacoco/test/html/
